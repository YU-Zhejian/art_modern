# Readme for Developers

## Motivation

ART is an excellent software for simulating reads from a reference genome. However, it comes with the following limitations:

- The implementation is not parallelized.
- The implementation may consume too much memory or fail on genomes that contain a limited number of chromosomes of enormous (larger than `signed int32`) sizes.
- The implementation may consume too much memory or fail on transcriptome or template collection that contains an enormous number of contigs (cDNAs or other types of template molecules).
- The implementation only supports unified coverage, which is not suitable for transcriptome simulation where each cDNA molecule has its own expression level.
- The implementation outputs alignments in SAM format, which is not space-efficient. We also spot some SAM records generated by `art_illumina` have CIGAR strings of inconsistent length.

So, we developed `art_modern` with the following ideas:

- Parallelization is implemented using another layer of abstraction, simulation job, which can be taken as a unit of work in one thread, etc.
- Writer for SAM output format was re-implemented using [HTSLib](https://www.htslib.org/), which allows supporting BAM and headless SAM/BAM output format with minimal modifications of code.
- Multiple FASTA parsers were added. For example, the `htslib` parser allows on-disk random access of enormous genomes without reading them into memory, while the `stream` parser allows streaming of FASTA files.
- The low-level I/O routines are made asyncronized to improve performance.
- Support other random number generators like Intel OneAPI Math Kernel Library (OneMKL).

## Common Development-Oriented Tasks

### Create Development Environment

Install [Conda](https://docs.conda.io/en/latest/) (Or [Mamba](https://mamba.readthedocs.io/en/latest/)/[MicroMamba](https://mamba.readthedocs.io/en/latest/micromamba.html)), and then execute:

```shell
conda env create -f art_modern.yml
```

Additional dependencies may include:

- [GNU Make](https://www.gnu.org/software/makel) is required to perform miscellaneous tasks, such as formatting the code, running test cases, performing profiling, etc.
- [Ninja](https://ninja-build.org) is used as the generator for the build system in the development environment.

### Testing

Some of the individual modules can be tested using CMake CTest system. Execute `ctest` in your building directory to test them.

Run `make testsmall` to run the integration tests using executables produced in `make build`.

### Profiling

Run `./profile.sh intel-advisor` to run the profiler using Intel Advisor. You have to have it installed to run this. We're now working on supporting Valgrind.

### Others

- Run `make fmt` to format the code.
- Run `make build` to build the executable using debug mode with default compiler found by CMake.
- Run `make scc` to count lines of code written.
- Run `make touch` to touch all files in the repository. This works when CMake does strange things like compiling the source files again and again.
- Run `make raw_data` to download essential test data useful to various integration tests, benchmarks, etc.

## Topics of `art_modern`

### Parallelism

The parallelization strategy of different modes and input parsers are as follows:

| Parser \ Mode | `wgs`     | `trans`   | `templ`   |
|---------------|-----------|-----------|-----------|
| `memory`      | Coverage  | Batch     | Batch     |
| `htslib`      | Coverage  | **ERROR** | **ERROR** |
| `stream`      | **ERROR** | Batch     | Batch     |

A proposed MPI-based parallelization strategy is in TODO.

## Get Engaged

You're welcome to submit issues on GitHub. Please make sure to include the following information:

1. `art_modern --version` output. In my own computer it generates some report like this:

    ```text
    ART: 2.5.8, ART_MODERN: 1.0.0
    ART_MODERN_LINK_LIBS: Boost::filesystem;Boost::regex;Boost::program_options;Boost::thread;Boost::log_setup;Boost::log;Boost::timer;Boost::stacktrace_backtrace;labw_slim_htslib;OpenMP::OpenMP_C;OpenMP::OpenMP_CXX;libceu
    USING HTSLib: labw_slim_htslib, ver. 1.15
            Features: build=CMake libcurl=no S3=no GCS=no libdeflate=yes lzma=yes bzip2=yes plugins=no htscodecs=1.2.1-2-g663bb94
            CC: /usr/bin/cc
            CPPFLAGS: 
            CFLAGS: -O0;-pg;-g3;-Og;-pedantic;-Wextra;-Wall
            LDFLAGS:
            HTSlib URL scheme handlers present:
                    built-in: preload, data, file
                    crypt4gh-needed: crypt4gh
                    mem: mem
    BOOST: 1.83.0
    GSL: not used
    MKL: not used
    MPI: not used
    Protobuf: not used
    OpenMP (C): 201511 v4.5
    OpenMP (CXX): 201511 v4.5
    Compile-time C std.: ver. unknown ISO C (__STDC_VERSION__ undefined)
    Compile-time C++ std.: ver. 17 (201703)
    Compiled at: Nov 28 2024, 19:44:44
    Compiler Identification:
            GCC compatible version number: 14.2.0
            __VERSION__ string: 14.2.0
    Compile-time C Types max, min, etc. limits:
            char           (8 bits, 1 size):                       -128 ->                  +127
            schar          (1 size):                       -128 ->                  +127
            uchar          (1 size):                         +0 ->                  +255
            std::size_t    (8 size):                         +0 ->  18446744073709551615
            std::ptrdiff_t (8 size):       -9223372036854775808 ->  +9223372036854775807
            short          (2 size):                     -32768 ->                +32767
            ushort          (2 size):                          0 ->                +65535
            int          (4 size):                -2147483648 ->           +2147483647
            uint         (4 size):                          0 ->            4294967295
            long         (8 size):       -9223372036854775808 ->  +9223372036854775807
            ulong        (8 size):                         +0 ->  18446744073709551615
            llong        (8 size):       -9223372036854775808 ->  +9223372036854775807
            ullong       (8 size):                         +0 ->  18446744073709551615
            bool        (1 size):      0 -> 1
    [2024-11-28 19:45:39.174414] info: EXIT
    ```

    You're expected to see more information if you link `art_modern` with Intel OneMKL, GSL, etc.
2. The CMake commandline you used to build the code.
3. The compilation log, if possible.
4. If you're familiar with Valgrind, please run `valgrind --tool=memcheck --leak-check=full --track-origins=yes --verbose --log-file=valgrind.log ./art_modern ...` and attach the `valgrind.log` file.
5. The git commit hash of the code you used.
